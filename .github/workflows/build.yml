name: Build DocuSearch Backend

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            tesseract-ocr \
            tesseract-ocr-eng \
            tesseract-ocr-hin \
            tesseract-ocr-ben \
            poppler-utils \
            patchelf \
            sstrip

      - name: Install Python dependencies
        run: |
          pip install \
            pyinstaller \
            staticx \
            uvicorn \
            fastapi \
            starlette \
            python-multipart \
            pymupdf \
            pillow \
            python-docx \
            python-jose \
            tinydb \
            pytesseract \
            pdf2image

      - name: Prepare tessdata
        run: |
          mkdir -p tessdata
          cp -r /usr/share/tesseract-ocr/5/tessdata/* ./tessdata/
          touch static/.keep

      - name: Patch PyMuPDF and Pillow for StaticX
        run: |
          SITE_PACKAGES=$(python -c "import site; print(site.getsitepackages()[0])")
          find "$SITE_PACKAGES" -type f -name "*.so*" \
            \( -path "*/pymupdf*" -o -path "*/fitz*" -o -path "*/pillow*" -o -path "*/Pillow*" -o -path "*/PIL*" \) \
            ! -name "*.bak" \
            -exec cp {} {}.bak \;
          find "$SITE_PACKAGES" -type f -name "*.so*" \
            \( -path "*/pymupdf*" -o -path "*/fitz*" -o -path "*/pillow*" -o -path "*/Pillow*" -o -path "*/PIL*" \) \
            ! -name "*.bak" \
            -exec patchelf --remove-rpath {} \;

      - name: Build with PyInstaller
        run: |
          pyinstaller --onefile \
            --collect-all uvicorn \
            --collect-all fastapi \
            --collect-all starlette \
            --collect-all docx \
            --collect-all fitz \
            --collect-all jose \
            --collect-all tinydb \
            --collect-all pdf2image \
            --hidden-import "uvicorn.logging" \
            --hidden-import "uvicorn.loops" \
            --hidden-import "uvicorn.loops.auto" \
            --hidden-import "uvicorn.protocols" \
            --hidden-import "uvicorn.protocols.http.auto" \
            --hidden-import "uvicorn.protocols.websockets.auto" \
            --hidden-import "uvicorn.lifespan.on" \
            --hidden-import "uvicorn.lifespan.off" \
            --hidden-import "multipart" \
            --hidden-import "python_multipart" \
            --add-data "templates:templates" \
            --add-data "static:static" \
            --add-data "tessdata:tessdata" \
            --add-binary "/usr/bin/tesseract:bin" \
            --add-binary "/usr/bin/pdftoppm:bin" \
            --add-binary "/usr/bin/pdftocairo:bin" \
            --add-binary "/usr/bin/pdfinfo:bin" \
            main.py

      - name: Bundle with StaticX
        run: |
          staticx dist/main dist/DocuSearch_Backend_Linux

      - name: Upload Linux binary
        uses: actions/upload-artifact@v4
        with:
          name: DocuSearch_Backend_Linux
          path: dist/DocuSearch_Backend_Linux


  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: |
          pip install `
            pyinstaller `
            uvicorn `
            fastapi `
            starlette `
            python-multipart `
            pymupdf `
            pillow `
            python-docx `
            python-jose `
            tinydb `
            pytesseract `
            pdf2image

      - name: Install Tesseract
        run: |
          choco install tesseract --yes
          echo "C:\Program Files\Tesseract-OCR" | Out-File -Append -FilePath $env:GITHUB_PATH

      - name: Install Poppler
        run: |
          choco install poppler --yes
          # Find and add poppler bin to PATH
          $popplerBin = Get-ChildItem "C:\ProgramData\chocolatey\lib\poppler" -Recurse -Filter "pdfinfo.exe" | Select-Object -First 1 -ExpandProperty DirectoryName
          echo $popplerBin | Out-File -Append -FilePath $env:GITHUB_PATH

      - name: Prepare tessdata and static
        run: |
          mkdir -p tessdata
          $tessdataSource = "C:\Program Files\Tesseract-OCR\tessdata"
          if (Test-Path $tessdataSource) {
            Copy-Item "$tessdataSource\*" -Destination "tessdata\" -Recurse
          }
          New-Item -ItemType File -Path "static\.keep" -Force

      - name: Find Tesseract and Poppler binaries
        id: binpaths
        run: |
          $tesseract = (Get-Command tesseract).Source
          $pdftoppm  = (Get-ChildItem "C:\ProgramData\chocolatey\lib\poppler" -Recurse -Filter "pdftoppm.exe"  | Select-Object -First 1).FullName
          $pdftocairo = (Get-ChildItem "C:\ProgramData\chocolatey\lib\poppler" -Recurse -Filter "pdftocairo.exe" | Select-Object -First 1).FullName
          $pdfinfo   = (Get-ChildItem "C:\ProgramData\chocolatey\lib\poppler" -Recurse -Filter "pdfinfo.exe"   | Select-Object -First 1).FullName
          echo "TESSERACT=$tesseract"     | Out-File -Append -FilePath $env:GITHUB_ENV
          echo "PDFTOPPM=$pdftoppm"       | Out-File -Append -FilePath $env:GITHUB_ENV
          echo "PDFTOCAIRO=$pdftocairo"   | Out-File -Append -FilePath $env:GITHUB_ENV
          echo "PDFINFO=$pdfinfo"         | Out-File -Append -FilePath $env:GITHUB_ENV

      - name: Build with PyInstaller
        run: |
          pyinstaller --onefile `
            --collect-all uvicorn `
            --collect-all fastapi `
            --collect-all starlette `
            --collect-all docx `
            --collect-all fitz `
            --collect-all jose `
            --collect-all tinydb `
            --collect-all pdf2image `
            --hidden-import "uvicorn.logging" `
            --hidden-import "uvicorn.loops" `
            --hidden-import "uvicorn.loops.auto" `
            --hidden-import "uvicorn.protocols" `
            --hidden-import "uvicorn.protocols.http.auto" `
            --hidden-import "uvicorn.protocols.websockets.auto" `
            --hidden-import "uvicorn.lifespan.on" `
            --hidden-import "uvicorn.lifespan.off" `
            --hidden-import "multipart" `
            --hidden-import "python_multipart" `
            --add-data "templates;templates" `
            --add-data "static;static" `
            --add-data "tessdata;tessdata" `
            --add-binary "$env:TESSERACT;bin" `
            --add-binary "$env:PDFTOPPM;bin" `
            --add-binary "$env:PDFTOCAIRO;bin" `
            --add-binary "$env:PDFINFO;bin" `
            main.py

      - name: Rename output
        run: Move-Item dist\main.exe dist\DocuSearch_Backend.exe

      - name: Upload Windows binary
        uses: actions/upload-artifact@v4
        with:
          name: DocuSearch_Backend_Windows
          path: dist\DocuSearch_Backend.exe